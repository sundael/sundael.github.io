<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"sundael.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="分布式会话 异常类： 绑定异常：参数校验异常 当我们部署多台系统，配合Nginx的时候会出现用户登录的问题 添加依赖，配置 使用Redis存储信息 12345 User user &#x3D;(User) redisTemplate.opsForValue().get(&quot;user:&quot; + ticket);if (user!&#x3D;null)&amp;#123;    CookieUtil.setCo">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Redis的秒杀">
<meta property="og:url" content="https://sundael.github.io/2022/04/28/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%A7%92%E6%9D%80/index.html">
<meta property="og:site_name" content="sundael">
<meta property="og:description" content="分布式会话 异常类： 绑定异常：参数校验异常 当我们部署多台系统，配合Nginx的时候会出现用户登录的问题 添加依赖，配置 使用Redis存储信息 12345 User user &#x3D;(User) redisTemplate.opsForValue().get(&quot;user:&quot; + ticket);if (user!&#x3D;null)&amp;#123;    CookieUtil.setCo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-28T06:14:33.000Z">
<meta property="article:modified_time" content="2022-05-03T02:37:52.722Z">
<meta property="article:author" content="solo">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://sundael.github.io/2022/04/28/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%A7%92%E6%9D%80/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sundael.github.io/2022/04/28/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%A7%92%E6%9D%80/","path":"2022/04/28/基于Redis的秒杀/","title":"基于Redis的秒杀"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>基于Redis的秒杀 | sundael</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">sundael</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D"><span class="nav-number">1.</span> <span class="nav-text">分布式会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E5%8A%9F%E8%83%BD"><span class="nav-number">2.</span> <span class="nav-text">秒杀功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8E%8B%E6%B5%8B"><span class="nav-number">3.</span> <span class="nav-text">系统压测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">4.</span> <span class="nav-text">页面优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">4.0.1.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="nav-number">4.0.2.</span> <span class="nav-text">页面静态化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">服务优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rabbitmq%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="nav-number">5.0.1.</span> <span class="nav-text">RabbitMQ交换机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redis%E9%A2%84%E5%87%8F%E5%BA%93%E5%AD%98"><span class="nav-number">5.0.2.</span> <span class="nav-text">redis预减库存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rabbitmq%E7%A7%92%E6%9D%80%E6%93%8D%E4%BD%9C"><span class="nav-number">5.0.3.</span> <span class="nav-text">RabbitMQ秒杀操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%BC%98%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">安全优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80%E9%9A%90%E8%97%8F"><span class="nav-number">6.0.1.</span> <span class="nav-text">秒杀接口地址隐藏</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="solo"
      src="/images/3.jpg">
  <p class="site-author-name" itemprop="name">solo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="/981450245@qq.com" title="E-Mail → 981450245@qq.com">E-Mail</a>
      </span>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sundael.github.io/2022/04/28/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E7%A7%92%E6%9D%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/3.jpg">
      <meta itemprop="name" content="solo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sundael">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          基于Redis的秒杀
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-28 14:14:33" itemprop="dateCreated datePublished" datetime="2022-04-28T14:14:33+08:00">2022-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-05-03 10:37:52" itemprop="dateModified" datetime="2022-05-03T10:37:52+08:00">2022-05-03</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="分布式会话">分布式会话</h2>
<p>异常类： 绑定异常：参数校验异常 当我们部署多台系统，配合Nginx的时候会出现用户登录的问题 添加依赖，配置 使用Redis存储信息 <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">User</span> <span class="keyword">user</span> =(<span class="keyword">User</span>) redisTemplate.opsForValue().<span class="keyword">get</span>(&quot;user:&quot; + ticket);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">user</span>!=<span class="keyword">null</span>)&#123;</span><br><span class="line">    CookieUtil.setCookie(request,response,&quot;userTicket&quot;,ticket);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure></p>
<p>如何优化？ 每次获取页面都要获取userticket，臃肿，获取user之前进行处理，在传到接口就进行判断，在后续代码中直接传入user</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">addArgumentResolvers</span>(<span class="params">List&lt;HandlerMethodArgumentResolver&gt; resolvers</span>)</span> &#123;</span><br><span class="line">    resolvers.add(userArgumentResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="秒杀功能">秒杀功能</h2>
<p>商品列表页<br>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;findGoodsVo&quot;</span> resultType=<span class="string">&quot;com.ljw.seckill.vo.GoodsVo&quot;</span>&gt;</span><br><span class="line">    SELECT</span><br><span class="line">    g<span class="selector-class">.id</span>,</span><br><span class="line">    g<span class="selector-class">.goods_name</span>,</span><br><span class="line">    g<span class="selector-class">.goods_title</span>,</span><br><span class="line">    g<span class="selector-class">.goods_img</span>,</span><br><span class="line">    g<span class="selector-class">.goods_detail</span>,</span><br><span class="line">    g<span class="selector-class">.goods_price</span>,</span><br><span class="line">    g<span class="selector-class">.goods_stock</span>,</span><br><span class="line">    sg<span class="selector-class">.seckill_price</span>,</span><br><span class="line">    sg<span class="selector-class">.stock_count</span>,</span><br><span class="line">    sg<span class="selector-class">.start_date</span>,</span><br><span class="line">    sg<span class="selector-class">.end_date</span></span><br><span class="line">    FROM</span><br><span class="line">    t_goods g</span><br><span class="line">    LEFT JOIN t_seckill_goods AS sg ON g.id=sg<span class="selector-class">.goods_id</span></span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>商品详情页 <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;findGoodsVoByGoodsId&quot;</span> resultType=<span class="string">&quot;com.ljw.seckill.vo.GoodsVo&quot;</span>&gt;</span><br><span class="line">       SELECT</span><br><span class="line">       g<span class="selector-class">.id</span>,</span><br><span class="line">       g<span class="selector-class">.goods_name</span>,</span><br><span class="line">       g<span class="selector-class">.goods_title</span>,</span><br><span class="line">       g<span class="selector-class">.goods_img</span>,</span><br><span class="line">       g<span class="selector-class">.goods_detail</span>,</span><br><span class="line">       g<span class="selector-class">.goods_price</span>,</span><br><span class="line">       g<span class="selector-class">.goods_stock</span>,</span><br><span class="line">       sg<span class="selector-class">.seckill_price</span>,</span><br><span class="line">       sg<span class="selector-class">.stock_count</span>,</span><br><span class="line">       sg<span class="selector-class">.start_date</span>,</span><br><span class="line">       sg<span class="selector-class">.end_date</span></span><br><span class="line">       FROM</span><br><span class="line">       t_goods g</span><br><span class="line">       LEFT JOIN t_seckill_goods AS sg ON g<span class="selector-class">.id</span> = sg<span class="selector-class">.goods_id</span></span><br><span class="line">       WHERE</span><br><span class="line">       g<span class="selector-class">.id</span> =#&#123;goodsId&#125;</span><br><span class="line">   &lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>登陆成功后图片展示不出来？ 提示：No mapping for get img 有配置文件和配置类的情况下，配置类优先级更高 <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">addResourceHandlers</span>(<span class="params">ResourceHandlerRegistry registry</span>)</span> &#123;</span><br><span class="line">    registry.addResourceHandler(<span class="string">&quot;/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/static/&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 一个id 一件,判断是否重复抢购 <figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SeckillOrder seckillOrder = seckillOrderService.getOne(new QueryWrapper&lt;SeckillOrder&gt;().e<span class="string">q(&quot;user_id&quot;, user.getId()</span>).e<span class="string">q(&quot;goods_id&quot;, goodsId)</span>);</span><br><span class="line"><span class="keyword">if</span> (seckillOrder!=null)&#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;errmsg&quot;</span>,RespBeanEnum.REPEATE_ERROR.getMessage());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;secKillFail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="系统压测">系统压测</h2>
<p>不同用户的测试 准备配置文件config.txt<br>
18012345678,bd055fb14eef4d1ea2933ff8d6e44575<br>
两个用户</p>
<p>准备5000个线程，循环10次（50000个线程）。压测商品列表接口，测试3次，查看结果。 压测商品列表接口 QPS：1119</p>
<p>秒杀 QPS 785.9</p>
<h2 id="页面优化">页面优化</h2>
<h4 id="缓存">缓存</h4>
<p>页面缓存 GoodsController <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">RequestMapping(<span class="params">value</span> = <span class="string">&quot;toList&quot;</span>,<span class="params">produces</span> = <span class="string">&quot;text/html;charset=utf-8&quot;</span>)</span></span><br><span class="line">@ResponseBody</span><br><span class="line">public String <span class="keyword">to</span><span class="constructor">List(User <span class="params">user</span>,Model <span class="params">model</span>,HttpServletRequest <span class="params">request</span>,HttpServletResponse <span class="params">response</span>)</span>&#123;</span><br><span class="line">    ValueOperations valueOperations = redisTemplate.ops<span class="constructor">ForValue()</span>;</span><br><span class="line">    String html =(String) valueOperations.get(<span class="string">&quot;goodsList&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">StringUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">html</span>)</span>)&#123;</span><br><span class="line">        return html;</span><br><span class="line">    &#125;</span><br><span class="line">    model.add<span class="constructor">Attribute(<span class="string">&quot;user&quot;</span>,<span class="params">user</span>)</span>;</span><br><span class="line">    model.add<span class="constructor">Attribute(<span class="string">&quot;goodsList&quot;</span>,<span class="params">goodsService</span>.<span class="params">findGoodsVo</span>()</span>);</span><br><span class="line">    WebContext webContext = <span class="keyword">new</span> <span class="constructor">WebContext(<span class="params">request</span>, <span class="params">response</span>, <span class="params">request</span>.<span class="params">getServletContext</span>()</span>, request.get<span class="constructor">Locale()</span>, model.<span class="keyword">as</span><span class="constructor">Map()</span>);</span><br><span class="line">    html=thymeleafViewResolver.get<span class="constructor">TemplateEngine()</span>.process(<span class="string">&quot;goodsList&quot;</span>,webContext);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">StringUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">html</span>)</span>)&#123;</span><br><span class="line">        valueOperations.set(<span class="string">&quot;goodsList&quot;</span>,html,<span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//thymeleafViewResolver.getTemplateEngine().process(&quot;goodsList&quot;,)</span></span><br><span class="line">    return <span class="string">&quot;goodList&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 局限性：分页的影响，只缓存前几页</p>
<p>对象缓存:用户 数据库中用户信息变更，缓存也变更 <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public RespBean update<span class="constructor">Password(String <span class="params">userTicket</span>, String <span class="params">password</span>, HttpServletRequest <span class="params">request</span>, HttpServletResponse <span class="params">response</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    User user = get<span class="constructor">UserByCookie(<span class="params">userTicket</span>, <span class="params">request</span>, <span class="params">response</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (user<span class="operator"> == </span>null) &#123;</span><br><span class="line">        throw <span class="keyword">new</span> <span class="constructor">GlobalException(RespBeanEnum.MOBILE_NOT_EXIST)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新密码</span></span><br><span class="line">    user.set<span class="constructor">Password(MD5util.<span class="params">inputPassToDBPass</span>(<span class="params">password</span>, <span class="params">user</span>.<span class="params">getSalt</span>()</span>));</span><br><span class="line">    <span class="built_in">int</span> result = userMapper.update<span class="constructor">ById(<span class="params">user</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span><span class="operator"> == </span>result) &#123;</span><br><span class="line">        <span class="comment">//更新了密码删除Redis</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;user:&quot;</span> + userTicket);</span><br><span class="line">        return <span class="module-access"><span class="module"><span class="identifier">RespBean</span>.</span></span>success<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="module-access"><span class="module"><span class="identifier">RespBean</span>.</span></span>error(RespBeanEnum.PASSWORD_UPDATE_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> QPS：1332-&gt;2342</p>
<h4 id="页面静态化">页面静态化</h4>
<p>页面缓存还是整个页面 ，利用浏览器做缓存</p>
<p>商品详情静态化<br>
后端直接传输对象 <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DetailVo detailVo = <span class="keyword">new</span> <span class="constructor">DetailVo()</span>;</span><br><span class="line">detailVo.set<span class="constructor">User(<span class="params">user</span>)</span>;</span><br><span class="line">detailVo.set<span class="constructor">GoodsVo(<span class="params">goodsVo</span>)</span>;</span><br><span class="line">detailVo.set<span class="constructor">SecKillStatus(<span class="params">secKillStatus</span>)</span>;</span><br><span class="line">detailVo.set<span class="constructor">RemainSeconds(<span class="params">remainSeconds</span>)</span>;</span><br><span class="line">return <span class="module-access"><span class="module"><span class="identifier">RespBean</span>.</span></span>success(detailVo);</span><br></pre></td></tr></table></figure></p>
<p>秒杀静态化<br>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">&quot;/doSeckill&quot;</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">RespBean <span class="title">doSeckill</span><span class="params">(User user, Long goodsId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="function"><span class="keyword">return</span> RespBean.<span class="title">error</span><span class="params">(RespBeanEnum.SESSION_ERROR)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">GoodsVo goods = goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line"><span class="comment">//判断库存</span></span><br><span class="line"><span class="keyword">if</span> (goods.getStockCount() &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="function"><span class="keyword">return</span> RespBean.<span class="title">error</span><span class="params">(RespBeanEnum.EMPTY_STOCK)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断是否重复抢购</span></span><br><span class="line">SeckillOrder seckillOrder = seckillOrderService.getOne(<span class="keyword">new</span></span><br><span class="line">QueryWrapper&lt;SeckillOrder&gt;().eq(<span class="string">&quot;user_id&quot;</span>,</span><br><span class="line">user.getId()).eq(</span><br><span class="line"><span class="string">&quot;goods_id&quot;</span>,</span><br><span class="line">goodsId));</span><br><span class="line"><span class="keyword">if</span> (seckillOrder != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="function"><span class="keyword">return</span> RespBean.<span class="title">error</span><span class="params">(RespBeanEnum.REPEATE_ERROR)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">Order order = orderService.seckill(user, goods);</span><br><span class="line"><span class="function"><span class="keyword">return</span> RespBean.<span class="title">success</span><span class="params">(order)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 加载不出图片： 304状态码，超过时间才会请求 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#静态资源处理</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="comment">#启用默认静态资源处理，默认启用</span></span><br><span class="line"><span class="attr">add-mappings:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">cachecontrol:</span></span><br><span class="line"><span class="comment">#缓存响应时间，单位秒</span></span><br><span class="line"><span class="attr">max-age:</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure></p>
<p>订单详情静态化 <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public OrderDetailVo detail(Long orderId) &#123;</span><br><span class="line"><span class="keyword">if</span> (null==orderId)&#123;</span><br><span class="line">throw <span class="keyword">new</span> <span class="constructor">GlobalException(RespBeanEnum.ORDER_NOT_EXIST)</span>;</span><br><span class="line">&#125;</span><br><span class="line">Order order = orderMapper.select<span class="constructor">ById(<span class="params">orderId</span>)</span>;</span><br><span class="line">GoodsVo goodsVo = goodsService.find<span class="constructor">GoodsVoByGoodsId(<span class="params">order</span>.<span class="params">getGoodsId</span>()</span>);</span><br><span class="line">OrderDetailVo detail = <span class="keyword">new</span> <span class="constructor">OrderDetailVo()</span>;</span><br><span class="line">detail.set<span class="constructor">GoodsVo(<span class="params">goodsVo</span>)</span>;</span><br><span class="line">detail.set<span class="constructor">Order(<span class="params">order</span>)</span>;</span><br><span class="line">return detail;</span><br></pre></td></tr></table></figure> 解决库存超卖<br>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seckillGoods.set<span class="constructor">StockCount(<span class="params">seckillGoods</span>.<span class="params">getStockCount</span>()</span>-<span class="number">1</span>);</span><br><span class="line">变成</span><br><span class="line">seckillGoodsService.update(<span class="keyword">new</span> UpdateWrapper&lt;SeckillGoods&gt;<span class="literal">()</span>.set(<span class="string">&quot;stock_count&quot;</span>,seckillGoods.get<span class="constructor">StockCount()</span>).eq(<span class="string">&quot;id&quot;</span>,seckillGoods.get<span class="constructor">Id()</span>).gt(<span class="string">&quot;stock_count&quot;</span>,<span class="number">0</span>));</span><br></pre></td></tr></table></figure> 添加唯一索引：用户id+商品id唯一索引，解决一个用户秒杀多个商品 解决同一用户</p>
<h2 id="服务优化">服务优化</h2>
<ol type="1">
<li>通过Redis预减库存，减少数据库访问<br>
初始化把库存加载到Redis，库存够，将请求放入队列，给客户端返回在排队中</li>
<li>内存标记减少Redis访问<br>
</li>
<li>请求进入队列缓存，异步下单</li>
</ol>
<h4 id="rabbitmq交换机">RabbitMQ交换机</h4>
<ol type="1">
<li>Fanout模式（发布-订阅模式） 不处理路由键，只需要简单的将队里绑定到交换机上 发送到交换机的消息都会被转发到与该交换机绑定的所有队列上</li>
<li>Direct模式 所有发送到Direct Exchange的消息被转发到RouteKey中指定的Queue</li>
<li>Topic模式 所有发送到Topic Exchange的消息被转发到所有管线RouteKey中指定Topic的Queue上 Exchange将RouteKey和某Topic进行模糊匹配,此时队列需要绑定一个Topic</li>
</ol>
<h4 id="redis预减库存">redis预减库存</h4>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ValueOperations valueOperations = redisTemplate.<span class="built_in">opsForValue</span>();</span><br><span class="line"><span class="comment">//判断是否重复抢购</span></span><br><span class="line"><span class="keyword">String</span> seckillOrderJson = (<span class="keyword">String</span>) valueOperations.<span class="built_in">get</span>(<span class="string">&quot;order:&quot;</span> +</span><br><span class="line">user.<span class="built_in">getId</span>() + <span class="string">&quot;:&quot;</span> + goodsId);</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.<span class="built_in">isEmpty</span>(seckillOrderJson)) &#123;</span><br><span class="line"><span class="keyword">return</span> RespBean.<span class="built_in">error</span>(RespBeanEnum.REPEATE_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//内存标记,减少Redis访问</span></span><br><span class="line"><span class="keyword">if</span> (EmptyStockMap.<span class="built_in">get</span>(goodsId)) &#123;</span><br><span class="line"><span class="keyword">return</span> RespBean.<span class="built_in">error</span>(RespBeanEnum.EMPTY_STOCK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//预减库存</span></span><br><span class="line">Long stock = valueOperations.<span class="built_in">decrement</span>(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line"><span class="keyword">if</span> (stock &lt; <span class="number">0</span>) &#123;</span><br><span class="line">EmptyStockMap.<span class="built_in">put</span>(goodsId,<span class="literal">true</span>);</span><br><span class="line">valueOperations.<span class="built_in">increment</span>(<span class="string">&quot;seckillGoods:&quot;</span> + goodsId);</span><br><span class="line"><span class="keyword">return</span> RespBean.<span class="built_in">error</span>(RespBeanEnum.EMPTY_STOCK);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 请求入队，立即返回排队中</span></span><br><span class="line">SeckillMessage message = <span class="keyword">new</span> <span class="built_in">SeckillMessage</span>(user, goodsId);</span><br><span class="line">mqSender.<span class="built_in">sendsecKillMessage</span>(JsonUtil.<span class="built_in">object2JsonStr</span>(message));</span><br><span class="line"><span class="keyword">return</span> RespBean.<span class="built_in">success</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//系统初始化，把商品库存数量加载到Redis</span></span><br><span class="line">@<span class="function">Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> throws Exception </span>&#123;</span><br><span class="line">List&lt;GoodsVo&gt; list = goodsService.<span class="built_in">findGoodsVo</span>();</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.<span class="built_in">isEmpty</span>(list)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">list.forEach(goodsVo -&gt; &#123;</span><br><span class="line">redisTemplate.<span class="built_in">opsForValue</span>().<span class="built_in">set</span>(<span class="string">&quot;seckillGoods:&quot;</span> + goodsVo.<span class="built_in">getId</span>(),</span><br><span class="line">goodsVo.<span class="built_in">getStockCount</span>());</span><br><span class="line">EmptyStockMap.<span class="built_in">put</span>(goodsVo.<span class="built_in">getId</span>(), <span class="literal">false</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="rabbitmq秒杀操作">RabbitMQ秒杀操作</h4>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="built_in">String</span> QUEUE = <span class="string">&quot;seckillQueue&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="built_in">String</span> EXCHANGE = <span class="string">&quot;seckillExchange&quot;</span>;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="function"><span class="title">queue</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Queue(QUEUE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TopicExchange <span class="function"><span class="title">topicExchange</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(EXCHANGE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="function"><span class="title">binding01</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> BindingBuilder.bind(queue()).to(topicExchange()).with(<span class="string">&quot;seckill.#&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//发送秒杀信息</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQSender</span> </span>&#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">sendsecKillMessage</span>(<span class="params"><span class="built_in">String</span> message</span>)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;发送消息：&quot;</span> + message);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;seckillExchange&quot;</span>, <span class="string">&quot;seckill.msg&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQReceiver</span> </span>&#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IGoodsService goodsService;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IOrderService orderService;</span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">&quot;seckillQueue&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">receive</span>(<span class="params"><span class="built_in">String</span> msg</span>)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;QUEUE接受消息：&quot;</span> + msg);</span><br><span class="line">SeckillMessage message = JsonUtil.jsonStr2Object(msg,SeckillMessage.class);</span><br><span class="line">Long goodsId = message.getGoodsId();</span><br><span class="line">User user = message.getUser();</span><br><span class="line">GoodsVo goods = goodsService.findGoodsVoByGoodsId(goodsId);</span><br><span class="line"><span class="comment">//判断库存</span></span><br><span class="line"><span class="keyword">if</span> (goods.getStockCount() &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断是否重复抢购</span></span><br><span class="line"><span class="comment">// SeckillOrder seckillOrder = seckillOrderService.getOne(new</span></span><br><span class="line">QueryWrapper&lt;SeckillOrder&gt;().eq(<span class="string">&quot;user_id&quot;</span>,</span><br><span class="line"><span class="comment">// user.getId()).eq(</span></span><br><span class="line"><span class="comment">// &quot;goods_id&quot;,</span></span><br><span class="line"><span class="comment">// goodsId));</span></span><br><span class="line"><span class="built_in">String</span> seckillOrderJson = (<span class="built_in">String</span>)</span><br><span class="line">redisTemplate.opsForValue().get(<span class="string">&quot;order:&quot;</span> + user.getId() + <span class="string">&quot;:&quot;</span> + goodsId);</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isEmpty(seckillOrderJson)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">orderService.seckill(user, goods);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端轮询秒杀结果（主要是前端） <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">RequestMapping(<span class="params">value</span> = <span class="string">&quot;result&quot;</span>,<span class="params">method</span> = RequestMethod.GET)</span></span><br><span class="line">@ResponseBody</span><br><span class="line">public RespBean get<span class="constructor">Result(User <span class="params">user</span>,Long <span class="params">goodsId</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (user==null) &#123;</span><br><span class="line">        return <span class="module-access"><span class="module"><span class="identifier">RespBean</span>.</span></span>error(RespBeanEnum.SESSION_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    Long orderId = seckillOrderService.get<span class="constructor">Result(<span class="params">user</span>, <span class="params">goodsId</span>)</span>;</span><br><span class="line">    return <span class="module-access"><span class="module"><span class="identifier">RespBean</span>.</span></span>success(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>redis实现分布式锁, 进来一个线程先占位，当别的线程进来操作时，发现已经有人占位了，就会放弃或者稍后再试线程操作执行完成后，需要调用del指令释放位子</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line"><span class="built_in">public</span> <span class="type">void</span> testLock02()&#123;</span><br><span class="line">ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line"><span class="type">Boolean</span> isLock = valueOperations.setIfAbsent(&quot;k1&quot;,&quot;v1&quot;,<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">valueOperations.<span class="keyword">set</span>(&quot;name&quot;,&quot;xxxx&quot;);</span><br><span class="line">String <span class="type">name</span> = (String) valueOperations.<span class="keyword">get</span>(&quot;name&quot;);</span><br><span class="line"><span class="keyword">System</span>.<span class="keyword">out</span>.println(<span class="type">name</span>);</span><br><span class="line">redisTemplate.<span class="keyword">delete</span>(&quot;k1&quot;);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;有线程在使用，请稍后&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>lua脚本<br>
使用方便，Redis内置了对Lua脚本的支持<br>
Lua脚本可以在Rdis服务端原子的执行多个Redis命令<br>
由于网络在很大程度上会影响到Redis性能，使用Lua脚本可以让多个命令一次执行，可以有 效解决网络给Redis带来的性能问题</p>
<p>优化redis预减库存 <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stock.lua </span><br><span class="line"><span class="keyword">if</span> (redis.<span class="keyword">call</span>(<span class="string">&#x27;exists&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line"><span class="keyword">local</span> stock = tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, KEYS[<span class="number">1</span>]));</span><br><span class="line"><span class="keyword">if</span> (stock &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>, KEYS[<span class="number">1</span>], <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">return</span> stock;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="安全优化">安全优化</h2>
<h4 id="秒杀接口地址隐藏">秒杀接口地址隐藏</h4>
<p>秒杀开始之前，先去请求接口获取秒杀地址 <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//获取秒杀地址</span><br><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> String createPath(<span class="keyword">User</span> <span class="keyword">user</span>, Long goodsId) &#123;</span><br><span class="line">    String str = MD5util.md5(UUIDUtil.uuid() + &quot;123456&quot;);</span><br><span class="line">    redisTemplate.opsForValue().<span class="keyword">set</span>(&quot;seckillPath:&quot;+<span class="keyword">user</span>.getId()+&quot;:&quot;+goodsId,str,<span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line">//校验秒杀地址</span><br><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> <span class="type">boolean</span> <span class="keyword">check</span>(<span class="keyword">User</span> <span class="keyword">user</span>, Long goodsId, String <span class="type">path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">user</span>==<span class="keyword">null</span>||goodsId&lt;<span class="number">0</span>|| StringUtils.isEmpty(<span class="type">path</span>))&#123;<span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">    String redisPath =(String) redisTemplate.opsForValue().<span class="keyword">get</span>(&quot;seckillPath:&quot; + <span class="keyword">user</span>.getId() + &quot;:&quot; + goodsId);</span><br><span class="line">    <span class="keyword">return</span> <span class="type">path</span>.equals(redisPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> #### 接口限流</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> <span class="type">boolean</span> preHandle(HttpServletRequest request, HttpServletResponse</span><br><span class="line">response, <span class="keyword">Object</span> <span class="keyword">handler</span>) throws <span class="keyword">Exception</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">handler</span> instanceof HandlerMethod)&#123;</span><br><span class="line"><span class="keyword">User</span> <span class="keyword">user</span> = getUser(request,response);</span><br><span class="line">UserContext.setUser(<span class="keyword">user</span>);</span><br><span class="line">HandlerMethod hm = (HandlerMethod) <span class="keyword">handler</span>;</span><br><span class="line">AccessLimit accessLimit = hm.getMethodAnnotation(AccessLimit.<span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">if</span> (accessLimit==<span class="keyword">null</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> second = accessLimit.second();</span><br><span class="line"><span class="type">int</span> maxCount = accessLimit.maxCount();</span><br><span class="line"><span class="type">boolean</span> needLogin = accessLimit.needLogin();</span><br><span class="line">String key = request.getRequestURI();</span><br><span class="line"><span class="keyword">if</span> (needLogin)&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">user</span>==<span class="keyword">null</span>)&#123;</span><br><span class="line">render(response,RespBeanEnum.SESSION_ERROR);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">key += &quot;:&quot;+<span class="keyword">user</span>.getId();</span><br><span class="line">&#125;</span><br><span class="line">ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line"><span class="type">Integer</span> count = (<span class="type">Integer</span>) valueOperations.<span class="keyword">get</span>(key);</span><br><span class="line"><span class="keyword">if</span> (count == <span class="keyword">null</span>) &#123;</span><br><span class="line">valueOperations.<span class="keyword">set</span>(key, <span class="number">1</span>, second, TimeUnit.SECONDS);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt; maxCount) &#123;</span><br><span class="line">valueOperations.increment(key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">render(response,RespBeanEnum.ACCESS_LIMIT_REACHED);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag"># 项目</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04/27/%E5%8E%9F%E5%9C%B0%E4%BF%AE%E6%94%B9%E6%95%B0%E7%BB%84/" rel="prev" title="原地修改数组">
                  <i class="fa fa-chevron-left"></i> 原地修改数组
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/03/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" rel="next" title="动态规划">
                  动态规划 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">solo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
